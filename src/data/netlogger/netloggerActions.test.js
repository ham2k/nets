import configureMockStore from 'redux-mock-store'
import thunk from 'redux-thunk'

import { getInitialData, getNetSubscription } from './netloggerActions'
import setupNetloggerSamples from './samples'

const middlewares = [thunk]
const mockStore = configureMockStore(middlewares)

describe('NetLogger API Calls', () => {
  beforeEach(() => {
    fetch.resetMocks()
    setupNetloggerSamples()
  })

  describe('Load initial data', () => {
    test('Loads server list', (done) => {
      const store = mockStore({})

      store
        .dispatch(getInitialData())
        .then(() => {
          // First round of dispatch will execute the `getInitialData` thunk
          // Second round, via `setImmediate`, will execute the `getServerInfo` thunks generated by `getInitialData`
          // Third round, via `setImmediate`, will execute the `getNetsList` thunks generated by `getServerInfo`
          setImmediate(() => {
            const actions = store.getActions()
            expect(actions.length).toBe(7)

            expect(actions[0].type).toBe('netlogger/setServerList')
            expect(actions[0].payload).toEqual([
              'http://www.netlogger.org:80',
              'http://www.netlogger1.org:80',
              'http://www.netlogger2.org:80',
            ])

            expect(actions[1].type).toBe('netlogger/setServerInfo')
            expect(actions[1].payload).toMatchObject({
              ServerHost: 'http://www.netlogger.org:80',
              ServerName: 'NETLOGGER',
              ClusterName: 'NETLOGGER',
              DefaultAIMInterval: '30000',
              ServerListURL: 'http://www.netlogger.org/downloads/ServerList.txt',
            })
            expect(actions[2].type).toBe('netlogger/setServerInfo')
            expect(actions[2].payload).toMatchObject({
              ServerHost: 'http://www.netlogger1.org:80',
              ServerName: 'NETLOGGER1',
              ClusterName: 'NETLOGGER1',
              DefaultAIMInterval: '20000',
              ServerListURL: 'http://www.netlogger.org/downloads/ServerList.txt',
            })
            expect(actions[3].type).toBe('netlogger/setServerInfo')
            expect(actions[3].payload).toMatchObject({
              ServerHost: 'http://www.netlogger2.org:80',
              ServerName: 'NETLOGGER2',
              ClusterName: 'NETLOGGER2',
              DefaultAIMInterval: '20000',
              ServerListURL: 'http://www.netlogger.org/downloads/ServerList.txt',
            })

            expect(actions[4].type).toBe('netlogger/addNets')
            expect(actions[4].payload).toEqual([])

            expect(actions[5].type).toBe('netlogger/addNets')
            expect(actions[5].payload.length).toBe(24)
            expect(actions[5].payload[0]).toMatchObject({
              NetName: '160m net on 1900kHz',
              NetControl: 'KE8USA',
              Frequency: '1.9MHz',
            })
            expect(actions[5].payload[3]).toMatchObject({
              NetName: 'BARS Thursday Night Net',
              NetControl: 'KD9LDD',
              Frequency: '147.330',
            })
            expect(actions[5].payload[23]).toMatchObject({
              NetName: 'WC5C Weekly Net',
              NetControl: 'AC5V',
              Frequency: '147.16',
            })

            expect(actions[6].type).toBe('netlogger/addNets')
            expect(actions[6].payload).toEqual([])

            done()
          })
        })
        .catch((error) => {
          done(error)
        })
    })
  })

  describe('Subscribe to Net', () => {
    test('Subscribes to a net', (done) => {
      const store = mockStore({
        netlogger: {
          nets: {
            'Graveyard Net': {
              NetName: 'Graveyard Net',
              ServerHost: 'http://www.netlogger1.org:80',
              ServerName: 'NETLOGGER1',
            },
          },
        },
      })
      store
        .dispatch(getNetSubscription('Graveyard Net'))
        .then(() => {
          const actions = store.getActions()
          expect(actions.length).toBe(1)
          expect(actions[0].type).toBe('netlogger/addNetData')
          expect(actions[0].payload.NetName).toBe('Graveyard Net')
          expect(actions[0].payload.checkins.length).toBe(19)
          expect(actions[0].payload.checkins[0]).toMatchObject({
            Callsign: 'KD2OAM',
            PreferredName: 'John',
          })
          expect(actions[0].payload.checkins[7]).toMatchObject({
            Callsign: 'N2VZD',
            County: 'Onondaga',
          })
          expect(actions[0].payload.checkins[14]).toMatchObject({
            Callsign: 'WA1CYL',
            Grid: 'FN54uo',
            operating: true,
          })

          expect(actions[0].payload.monitors.length).toBe(14)
          expect(actions[0].payload.monitors[0]).toMatchObject({
            NamePlusVersion: 'KD2OAM-JOHN - v3.1.7W',
            IPAddress: '74.70.11.192',
          })

          expect(actions[0].payload.ims.length).toBe(13)
          expect(actions[0].payload.ims[0]).toMatchObject({
            ID: '4159589',
            Name: 'KD2OAM-JOHN',
            Message:
              'Welcome to the Graveyard Net. Net starts at 06:00 and will go to 08:00. Your host for this morning is John, KD2OAM. All are welcome to participate.',
          })

          expect(actions[0].payload).toMatchObject({
            Frequency: '3.967',
            MiscNetParameters: '',
            InactivityTimer: '30',
          })
          done()
        })
        .catch((error) => {
          done(error)
        })
    })
  })
})
